{% extends "core/base.html" %}

{% block title %}Pending Payments · Broker Portal{% endblock %}
{% block page_title %}Pending Payments{% endblock %}
{% block page_subtitle %}Two separate sections: Clients owe you vs You owe clients{% endblock %}

{% block content %}
<style>
    * {
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
    }
    
    .pending-container {
        max-width: 1400px;
        margin: 0 auto;
        transform: scale(1) !important;
        zoom: 1 !important;
        -webkit-transform: scale(1) !important;
    }
    
    .alert-message {
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        background: #ffffff;
        color: #111827;
        border-left: 3px solid #6b7280;
        font-size: 14px;
        line-height: 1.6;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .tabs-container {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        background: transparent;
        padding: 0;
    }
    
    .tab-button {
        padding: 12px 28px;
        background: #ffffff;
        color: #6b7280;
        border: 1px solid #e5e7eb;
        border-radius: 8px 8px 0 0;
        border-bottom: none;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }
    
    .tab-button:hover {
        background: #f9fafb;
        color: #374151;
    }
    
    .tab-button.active {
        background: #ffffff;
        color: #111827;
        font-weight: 600;
        border-bottom: 2px solid #ffffff;
        margin-bottom: -1px;
    }
    
    .section-content {
        background: #ffffff;
        border-radius: 8px;
        padding: 28px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        border: 1px solid #e5e7eb;
        transition: none !important;
        transform: scale(1) !important;
        -webkit-transform: scale(1) !important;
        will-change: auto;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
    }
    
    .section-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
        color: #111827;
        letter-spacing: -0.01em;
        padding-bottom: 12px;
        border-bottom: 1px solid #f3f4f6;
    }
    
    .summary-card {
        background: linear-gradient(to right, #f9fafb, #ffffff);
        border-radius: 8px;
        padding: 20px 24px;
        margin-bottom: 24px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    
    .summary-amount {
        font-size: 28px;
        font-weight: 700;
        color: #111827;
        margin-bottom: 6px;
        letter-spacing: -0.01em;
    }
    
    .summary-note {
        font-size: 13px;
        color: #6b7280;
        line-height: 1.5;
    }
    
    .table-container {
        background: #ffffff;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        overflow: hidden;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    
    .table-header-info {
        padding: 14px 20px;
        border-bottom: 1px solid #e5e7eb;
        background: #fafafa;
        font-size: 13px;
        color: #6b7280;
        font-weight: 500;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .data-table thead {
        background: #f9fafb;
    }
    
    .data-table th {
        padding: 14px 20px;
        text-align: left;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: #6b7280;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .data-table td {
        padding: 16px 20px;
        border-bottom: 1px solid #f3f4f6;
        font-size: 14px;
        color: #111827;
    }
    
    .data-table tbody tr:hover {
        background: #f9fafb;
    }
    
    .data-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    .client-link {
        color: #111827;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s;
    }
    
    .client-link:hover {
        color: #374151;
        text-decoration: underline;
    }
    
    .amount-value {
        font-size: 15px;
        font-weight: 600;
        color: #111827;
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        letter-spacing: 0.02em;
    }
    
    .action-button {
        padding: 7px 14px;
        background: #111827;
        color: #ffffff;
        border: none;
        border-radius: 5px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    
    .action-button:hover {
        background: #374151;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #9ca3af;
        font-size: 15px;
    }
    
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
    }
    
    .modal-content {
        background: #ffffff;
        border-radius: 10px;
        padding: 28px;
        border: 1px solid #e5e7eb;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 14px;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: #111827;
        margin: 0;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #6b7280;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s;
    }
    
    .modal-close:hover {
        background: #f3f4f6;
        color: #111827;
    }
    
    .form-group {
        margin-bottom: 18px;
    }
    
    .form-label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 8px;
    }
    
    .form-input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 6px;
        border: 1px solid #d1d5db;
        background: #ffffff;
        color: #111827;
        font-size: 14px;
        transition: all 0.2s;
    }
    
    .form-input:focus {
        outline: none;
        border-color: #111827;
        box-shadow: 0 0 0 2px rgba(17, 24, 39, 0.08);
    }
    
    .form-input[readonly] {
        background: #f9fafb;
        color: #6b7280;
    }
    
    .form-help {
        font-size: 12px;
        color: #6b7280;
        margin-top: 6px;
        line-height: 1.4;
    }
    
    .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 24px;
        padding-top: 18px;
        border-top: 1px solid #e5e7eb;
    }
    
    .btn-primary {
        flex: 1;
        padding: 10px 18px;
        background: #111827;
        color: #ffffff;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-primary:hover {
        background: #374151;
    }
    
    .btn-secondary {
        padding: 10px 18px;
        background: #ffffff;
        color: #374151;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-secondary:hover {
        background: #f9fafb;
        border-color: #9ca3af;
    }
    
    .combine-shares-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 8px 12px;
        background: #f9fafb;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
        transition: all 0.2s;
        user-select: none;
        position: relative;
        pointer-events: auto;
    }
    
    .combine-shares-toggle:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
    }
    
    .combine-shares-toggle input[type="checkbox"] {
        cursor: pointer;
        width: 18px;
        height: 18px;
        margin: 0;
        pointer-events: auto;
        z-index: 10;
        position: relative;
        flex-shrink: 0;
        opacity: 1;
        appearance: checkbox;
        -webkit-appearance: checkbox;
    }
    
    .combine-shares-toggle span {
        font-size: 13px;
        font-weight: 500;
        color: #374151;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .section-header .section-title {
        margin-bottom: 0;
    }
</style>

<div class="pending-container">
{% if messages %}
    <div>
        {% for message in messages %}
            <div class="alert-message">
                {{ message }}
            </div>
        {% endfor %}
    </div>
        {% endif %}

<!-- Tab Headers -->
<div class="tabs-container">
    <button onclick="showSection('clients-owe')" id="tab-clients-owe" class="tab-button active">
        Clients Owe You
    </button>
    <button onclick="showSection('you-owe')" id="tab-you-owe" class="tab-button">
        You Owe Clients
    </button>
</div>

<div id="section-clients-owe" class="section-content" style="display: block;">
    <div class="section-header">
        <h2 class="section-title">
            Clients Owe You (Pending Amount - Unpaid Losses)
        </h2>
        <label class="combine-shares-toggle" for="combine-shares-toggle-clients">
            <input type="checkbox" id="combine-shares-toggle-clients" {% if combine_shares %}checked{% endif %} onchange="toggleCombineShares(this)" onclick="return true;">
            <span>Combine My Share & Company Share</span>
        </label>
    </div>
    {% if total_pending %}
    <div class="summary-card">
        <div class="summary-amount">
            Total Pending: ₹ {{ total_pending|floatformat:1 }}
        </div>
        <div class="summary-note">
            Pending is a separate ledger - only affected by losses and client payments
        </div>
    </div>
    {% endif %}
    <div class="table-container">
        <div class="table-header-info">
            Total clients: {{ clients_owe|length }}
        </div>
        <table class="data-table">
            <thead>
            <tr>
                <th>Client Code</th>
                <th>Client Name</th>
                <th>Exchange</th>
                <th>Old Balance</th>
                <th>Current Balance</th>
                <th class="share-header my-share-header">My Share</th>
                <th class="share-header company-share-header">Company Share</th>
                <th class="share-header combined-share-header" style="display: none;">Combined Share (My + Company)</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for item in clients_owe %}
                <tr>
                    <td><strong>{% if item.client_code %}{{ item.client_code }}{% else %}<span style="color: #9ca3af;">—</span>{% endif %}</strong></td>
                    <td>
                        <a href="{% url 'clients:balance' item.client_id %}?exchange={{ item.client_exchange_id }}" class="client-link">
                            {{ item.client_name }}
                        </a>
                    </td>
                    <td>{{ item.exchange_name }}</td>
                    <td>₹ {{ item.old_balance|floatformat:1 }}</td>
                    <td>₹ {{ item.exchange_balance|floatformat:1 }}</td>
                    <td class="share-cell my-share-cell" data-my-share="{{ item.my_share|default:0 }}" data-company-share="{{ item.company_share|default:0 }}" data-combined-share="{{ item.combined_share|default:0 }}">
                        <span class="amount-value">₹ {{ item.my_share|default:0|floatformat:1 }}</span>
                    </td>
                    <td class="share-cell company-share-cell" data-my-share="{{ item.my_share|default:0 }}" data-company-share="{{ item.company_share|default:0 }}" data-combined-share="{{ item.combined_share|default:0 }}">
                        <span class="amount-value">₹ {{ item.company_share|default:0|floatformat:1 }}</span>
                    </td>
                    <td class="share-cell combined-share-cell" data-my-share="{{ item.my_share|default:0 }}" data-company-share="{{ item.company_share|default:0 }}" data-combined-share="{{ item.combined_share|default:0 }}" style="display: none;">
                        <span class="amount-value">₹ {{ item.combined_share|default:0|floatformat:1 }}</span>
                    </td>
                    <td>
                        <button onclick="showSettlementForm({{ item.client_id }}, {{ item.client_exchange_id }}, '{{ item.client_name|escapejs }}', '{{ item.exchange_name|escapejs }}', {{ item.pending_amount }}, 'client_pays', {{ item.my_share|default:0 }}, {{ item.company_share|default:0 }}, {{ item.combined_share|default:0 }}, {{ item.is_company_client|yesno:"true,false" }})" class="action-button">
                            Record Payment
                        </button>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="8" class="empty-state">No pending amounts for the selected period.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="section-you-owe" class="section-content" style="display: none;">
    <div class="section-header">
        <h2 class="section-title">
            You Owe Clients (Your Loss/Expense)
        </h2>
        <label class="combine-shares-toggle" for="combine-shares-toggle">
            <input type="checkbox" id="combine-shares-toggle" {% if combine_shares %}checked{% endif %} onchange="toggleCombineShares(this)" onclick="return true;">
            <span>Combine My Share & Company Share</span>
        </label>
    </div>
    {% if total_profit %}
    <div class="summary-card">
        <div class="summary-amount">
            Total Amount to Pay: ₹ {{ total_profit|floatformat:1 }}
        </div>
        <div class="summary-note">
            This is your loss/expense - amount you need to pay to clients. Payment does NOT affect pending amount (separate ledger)
        </div>
    </div>
    {% endif %}
    <div class="table-container">
        <div class="table-header-info">
            Total clients: {{ you_owe|length }}
        </div>
        <table class="data-table">
            <thead>
            <tr>
                <th>Client Code</th>
                <th>Client Name</th>
                <th>Exchange</th>
                <th>Total Funding</th>
                <th>Exchange Balance</th>
                <th class="share-header my-share-header">My Share</th>
                <th class="share-header company-share-header">Company Share</th>
                <th class="share-header combined-share-header" style="display: none;">Combined Share (My + Company)</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for item in you_owe %}
                <tr>
                    <td><strong>{% if item.client_code %}{{ item.client_code }}{% else %}<span style="color: #9ca3af;">—</span>{% endif %}</strong></td>
                    <td>
                        <a href="{% url 'clients:balance' item.client_id %}?exchange={{ item.client_exchange_id }}" class="client-link">
                            {{ item.client_name }}
                        </a>
                    </td>
                    <td>{{ item.exchange_name }}</td>
                    <td>₹ {{ item.total_funding|floatformat:1 }}</td>
                    <td>₹ {{ item.exchange_balance|floatformat:1 }}</td>
                    <td class="share-cell my-share-cell" data-my-share="{{ item.my_share|default:0 }}" data-company-share="{{ item.company_share|default:0 }}" data-combined-share="{{ item.combined_share|default:0 }}">
                        <span class="amount-value">₹ {{ item.my_share|default:0|floatformat:1 }}</span>
                    </td>
                    <td class="share-cell company-share-cell" data-my-share="{{ item.my_share|default:0 }}" data-company-share="{{ item.company_share|default:0 }}" data-combined-share="{{ item.combined_share|default:0 }}">
                        <span class="amount-value">₹ {{ item.company_share|default:0|floatformat:1 }}</span>
                    </td>
                    <td class="share-cell combined-share-cell" data-my-share="{{ item.my_share|default:0 }}" data-company-share="{{ item.company_share|default:0 }}" data-combined-share="{{ item.combined_share|default:0 }}" style="display: none;">
                        <span class="amount-value">₹ {{ item.combined_share|default:0|floatformat:1 }}</span>
                    </td>
                    <td>
                        <button onclick="showSettlementForm({{ item.client_id }}, {{ item.client_exchange_id }}, '{{ item.client_name }}', '{{ item.exchange_name }}', {{ item.client_profit }}, 'admin_pays_profit', 0, 0, 0, {{ item.is_company_client|yesno:"true,false" }})" class="action-button">
                            Pay Client
                        </button>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="8" class="empty-state">You don't owe any clients for the selected period.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Settlement Form Modal -->
<div id="settlement-form" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Settle Payment</h2>
            <button onclick="hideSettlementForm()" class="modal-close">&times;</button>
        </div>
        <form method="post" action="" id="settlement-form-content" onsubmit="return handleFormSubmit(event);" data-my-clients-url="{% url 'my_clients:settle_payment' %}" data-company-clients-url="{% url 'company_clients:settle_payment' %}">
            {% csrf_token %}
            <input type="hidden" name="client_id" id="settle-client-id">
            <input type="hidden" name="client_exchange_id" id="settle-client-exchange-id">
            <input type="hidden" name="payment_type" id="settle-payment-type" value="client_pays">
            <input type="hidden" name="report_type" value="{{ report_type }}">
            <input type="hidden" name="client_type" value="{{ client_type_filter|default:'all' }}">
            <input type="hidden" name="section" id="section-param" value="clients-owe">
            
            <div class="form-group">
                <label class="form-label">Client</label>
                <input type="text" id="settle-client-name" class="form-input" readonly>
            </div>
            
            <div class="form-group">
                <label class="form-label">Exchange</label>
                <input type="text" id="settle-exchange-name" class="form-input" readonly>
            </div>
            
            <div class="form-group">
                <label class="form-label">Amount to Pay (₹) *</label>
                <input type="number" name="amount" id="settle-amount" class="form-input" step="0.1" min="0" max="0" required placeholder="0.0" data-combined-share="0" data-max-amount="0">
                <div id="share-info" class="form-help" style="display: none; margin-top: 8px; padding: 12px; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span style="font-size: 13px; color: #6b7280;">My Share:</span>
                        <span id="settle-my-share" style="font-size: 14px; font-weight: 600; color: #111827;">₹ 0.0</span>
                    </div>
                    <div id="settle-company-share-row" style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span style="font-size: 13px; color: #6b7280;">Company Share:</span>
                        <span id="settle-company-share" style="font-size: 14px; font-weight: 600; color: #111827;">₹ 0.0</span>
                    </div>
                    <div id="settle-combined-share-row" style="display: flex; justify-content: space-between; padding-top: 6px; border-top: 1px solid #e5e7eb; margin-top: 6px;">
                        <span style="font-size: 13px; font-weight: 600; color: #374151;">Combined Share:</span>
                        <span id="settle-combined-share" style="font-size: 15px; font-weight: 700; color: #111827;">₹ 0.0</span>
                    </div>
                    <div id="settle-info-text" style="margin-top: 8px; font-size: 12px; color: #6b7280; font-style: italic;">
                        These are your earnings from this loss (informational)
                    </div>
                </div>
                <div id="pending-info" class="form-help" style="display: none;">
                    <span id="pending-amount-text"></span> - You can pay any amount (partial or full)
                </div>
                <div id="profit-payment-info" class="form-help" style="display: none; margin-top: 8px; padding: 10px; background: #fef3c7; border-radius: 6px; border: 1px solid #fbbf24;">
                    <div style="font-size: 12px; color: #92400e; font-weight: 500;">
                        ⚠️ Important: You pay ONLY your share amount, NOT the full profit. The remaining balance stays in the exchange.
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Date *</label>
                <input type="date" name="date" class="form-input" value="{% now 'Y-m-d' %}" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Note (Optional)</label>
                <textarea name="note" class="form-input" rows="3" placeholder="Add any notes about this settlement" style="resize: vertical;"></textarea>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn-primary" id="settle-submit-button">Record Payment</button>
                <button type="button" onclick="hideSettlementForm()" class="btn-secondary">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    function showSettlementForm(clientId, clientExchangeId, clientName, exchangeName, amount, paymentType, myShare, companyShare, combinedShare, isCompanyClient) {
        try {
            console.log('showSettlementForm called with:', {
                clientId, clientExchangeId, clientName, exchangeName, amount, paymentType, myShare, companyShare, combinedShare, isCompanyClient
            });
            
            // Handle optional parameters
            myShare = myShare || 0;
            companyShare = companyShare || 0;
            combinedShare = combinedShare || 0;
            paymentType = paymentType || 'client_pays';
            isCompanyClient = isCompanyClient === true || isCompanyClient === 'true';
            
            // Set form action URL based on client type FIRST, before setting other values
            const form = document.getElementById('settlement-form-content');
            if (!form) {
                console.error('CRITICAL: Settlement form not found!');
                alert('Error: Settlement form not found. Please refresh the page.');
                return;
            }
            
            console.log('Form found, setting up...');
            
            // Get URLs from data attributes (more reliable than template tags in JS)
            const companyClientsUrl = form.getAttribute('data-company-clients-url') || "{% url 'company_clients:settle_payment' %}";
            const myClientsUrl = form.getAttribute('data-my-clients-url') || "{% url 'my_clients:settle_payment' %}";
            
            console.log('URLs from data attributes:', {
                companyClientsUrl: companyClientsUrl,
                myClientsUrl: myClientsUrl,
                isCompanyClient: isCompanyClient
            });
            
            // Set form action based on client type
            // isCompanyClient is already converted to boolean above
            if (isCompanyClient) {
                form.action = companyClientsUrl;
                console.log('Set form action to company clients:', companyClientsUrl);
            } else {
                form.action = myClientsUrl;
                console.log('Set form action to my clients:', myClientsUrl);
            }
            
            // Verify form action was set
            if (!form.action || form.action === '' || form.action === '#') {
                console.error('CRITICAL ERROR: Form action not set!', {
                    isCompanyClient: isCompanyClient,
                    companyClientsUrl: companyClientsUrl,
                    myClientsUrl: myClientsUrl,
                    currentAction: form.action
                });
                alert('Error: Unable to set form action. Please refresh the page and try again.');
                return;
            }
            
            // Debug: log the form action
            console.log('Opening settlement form:', {
                isCompanyClient: isCompanyClient,
                formAction: form.action,
                clientId: clientId,
                clientExchangeId: clientExchangeId,
                amount: amount,
                paymentType: paymentType
            });
            
        document.getElementById('settle-client-id').value = clientId;
        document.getElementById('settle-client-exchange-id').value = clientExchangeId;
        document.getElementById('settle-client-name').value = clientName;
        document.getElementById('settle-exchange-name').value = exchangeName;
            document.getElementById('settle-payment-type').value = paymentType;
            
            // Store combined share for validation
            const combinedShareValue = parseFloat(combinedShare) || 0;
            const amountInput = document.getElementById('settle-amount');
            const profitPaymentInfo = document.getElementById('profit-payment-info');
            const pendingInfo = document.getElementById('pending-info');
            
            // For admin_pays_profit: You pay ONLY your share amount, NOT the full profit
            if (paymentType === 'admin_pays_profit') {
                // amount parameter is already the share amount (my_share) for company clients
                const shareAmount = parseFloat(amount) || 0;
                amountInput.value = shareAmount.toFixed(1);
                amountInput.max = shareAmount.toFixed(1);  // Max is the share amount only
                amountInput.setAttribute('data-max-amount', shareAmount.toFixed(1));
                amountInput.setAttribute('data-combined-share', '0');
                
                // Show warning that you only pay share amount
                if (profitPaymentInfo) {
                    profitPaymentInfo.style.display = 'block';
                }
                if (pendingInfo) {
                    pendingInfo.style.display = 'none';
                }
            } else if (paymentType === 'client_pays' && combinedShareValue > 0) {
                // For client_pays, set amount to combined share (not pending amount)
                amountInput.value = combinedShareValue.toFixed(1);
                amountInput.max = '';  // No max limit for client payments
                amountInput.setAttribute('data-combined-share', combinedShareValue.toFixed(1));
                amountInput.setAttribute('data-max-amount', '0');
                
                if (profitPaymentInfo) {
                    profitPaymentInfo.style.display = 'none';
                }
                if (pendingInfo) {
                    pendingInfo.style.display = 'block';
                }
            } else {
                amountInput.value = parseFloat(amount).toFixed(1);
                amountInput.max = '';
                amountInput.setAttribute('data-combined-share', '0');
                amountInput.setAttribute('data-max-amount', '0');
                
                if (profitPaymentInfo) {
                    profitPaymentInfo.style.display = 'none';
                }
                if (pendingInfo) {
                    pendingInfo.style.display = 'none';
                }
            }
        
        // Preserve client_type filter in form
            // First, try to get from existing hidden input (set by template)
            let hiddenInput = document.querySelector('input[name="client_type"]');
            let clientType = null;
            
            if (hiddenInput && hiddenInput.value) {
                clientType = hiddenInput.value;
                console.log('Using client_type from existing form input:', clientType);
            } else {
                // If not in form, get from URL
        const urlParams = new URLSearchParams(window.location.search);
                clientType = urlParams.get('client_type') || 'all';
                console.log('Using client_type from URL:', clientType);
                
                // Create the hidden input if it doesn't exist
            if (!hiddenInput) {
                hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'client_type';
                hiddenInput.id = 'settle-client-type';
                form.appendChild(hiddenInput);
            }
            hiddenInput.value = clientType;
            }
            
            // Always ensure the value is set (even if it's 'all')
            if (hiddenInput) {
                hiddenInput.value = clientType || 'all';
                console.log('Final client_type set in form:', hiddenInput.value);
        }
        
        // Update form title and button text based on payment type
        const formTitle = document.querySelector('.modal-title');
            const submitButton = document.getElementById('settle-submit-button') || document.querySelector('.btn-primary');
        const pendingInfo = document.getElementById('pending-info');
            const shareInfo = document.getElementById('share-info');
        const pendingAmountText = document.getElementById('pending-amount-text');
        
        if (paymentType === 'admin_pays_profit') {
            formTitle.textContent = 'Pay Client (Your Loss/Expense)';
            submitButton.textContent = 'Pay Client';
            pendingInfo.style.display = 'none';
                shareInfo.style.display = 'none';
            amountInput.max = '';
        } else {
            formTitle.textContent = 'Record Client Payment (Partial or Full)';
            submitButton.textContent = 'Record Payment';
                
                // Show share breakdown and set amount to combined share
                if (parseFloat(myShare) > 0 || parseFloat(companyShare) > 0 || parseFloat(combinedShare) > 0) {
                    document.getElementById('settle-my-share').textContent = '₹ ' + parseFloat(myShare).toFixed(1);
                    document.getElementById('settle-company-share').textContent = '₹ ' + parseFloat(companyShare).toFixed(1);
                    document.getElementById('settle-combined-share').textContent = '₹ ' + parseFloat(combinedShare).toFixed(1);
                    
                    // Hide company share row for my clients (not company clients)
                    const companyShareRow = document.getElementById('settle-company-share-row');
                    if (companyShareRow) {
                        if (isCompanyClient && parseFloat(companyShare) > 0) {
                            companyShareRow.style.display = 'flex';
                        } else {
                            companyShareRow.style.display = 'none';
                        }
                    }
                    
                    // Hide combined share row and informational text for my clients
                    const combinedShareRow = document.getElementById('settle-combined-share-row');
                    const infoText = document.getElementById('settle-info-text');
                    if (combinedShareRow) {
                        if (isCompanyClient) {
                            combinedShareRow.style.display = 'flex';
                        } else {
                            combinedShareRow.style.display = 'none';
                        }
                    }
                    if (infoText) {
                        if (isCompanyClient) {
                            infoText.style.display = 'block';
                        } else {
                            infoText.style.display = 'none';
                        }
                    }
                    
                    shareInfo.style.display = 'block';
                    pendingInfo.style.display = 'none';
                    
                    // Set amount to combined share (my share + company share) - this is the ONLY amount they can pay
                    const combinedShareValue = parseFloat(combinedShare) || 0;
                    if (combinedShareValue > 0) {
                        amountInput.value = combinedShareValue.toFixed(2);
                        // Max is the combined share - user can only pay this amount (My Share + Company Share)
                        amountInput.max = combinedShareValue.toFixed(2);
                        amountInput.setAttribute('data-combined-share', combinedShareValue.toFixed(2));
                        if (isCompanyClient) {
                            amountInput.placeholder = 'Combined Share (My + Company): ₹' + combinedShareValue.toFixed(2);
                        } else {
                            amountInput.placeholder = 'My Share: ₹' + combinedShareValue.toFixed(2);
                        }
                    } else {
                        // If combined share is 0, allow payment up to pending amount (fallback)
                        amountInput.value = parseFloat(amount).toFixed(2);
                        amountInput.max = parseFloat(amount).toFixed(2);
                        amountInput.setAttribute('data-combined-share', '0');
                        amountInput.placeholder = 'Enter amount (up to ₹' + parseFloat(amount).toFixed(2) + ')';
                    }
                } else {
                    shareInfo.style.display = 'none';
            pendingInfo.style.display = 'block';
            pendingAmountText.textContent = 'Pending Amount: ₹' + parseFloat(amount).toFixed(2);
            amountInput.max = parseFloat(amount).toFixed(2);
            amountInput.placeholder = 'Enter amount (up to ₹' + parseFloat(amount).toFixed(2) + ')';
                }
            }
            
            // Show the modal
            const modal = document.getElementById('settlement-form');
            if (!modal) {
                console.error('CRITICAL: Modal element not found!');
                alert('Error: Payment form modal not found. Please refresh the page.');
                return;
            }
            modal.style.display = 'flex';
            console.log('Modal displayed successfully');
        } catch (error) {
            console.error('Error in showSettlementForm:', error);
            alert('Error opening payment form: ' + error.message);
        }
    }
    
    function hideSettlementForm() {
        document.getElementById('settlement-form').style.display = 'none';
    }
    
    function handleFormSubmit(event) {
        console.log('handleFormSubmit called - form submission started');
        
        const form = document.getElementById('settlement-form-content');
        const amountInput = document.getElementById('settle-amount');
        const amount = parseFloat(amountInput.value);
        const paymentType = document.getElementById('settle-payment-type').value;
        const date = document.querySelector('input[name="date"]').value;
        const clientId = document.getElementById('settle-client-id').value;
        const clientExchangeId = document.getElementById('settle-client-exchange-id').value;
        
        // Validation: For admin_pays_profit, ensure amount doesn't exceed share amount
        if (paymentType === 'admin_pays_profit') {
            const maxAmount = parseFloat(amountInput.getAttribute('data-max-amount')) || 0;
            if (maxAmount > 0 && amount > maxAmount) {
                alert(`⚠️ You can only pay your share amount (₹${maxAmount.toFixed(1)}), not the full profit. Payments happen ONLY on SHARE, never on full profit.`);
                event.preventDefault();
                return false;
            }
        }
        
        console.log('Form data:', {
            amount: amount,
            paymentType: paymentType,
            date: date,
            clientId: clientId,
            clientExchangeId: clientExchangeId,
            formAction: form ? form.action : 'FORM NOT FOUND'
        });
        
        // Validate amount
        if (!amount || amount <= 0 || isNaN(amount)) {
            alert('Please enter a valid amount greater than 0');
            event.preventDefault();
            return false;
        }
        
        // For client_pays, validate that amount doesn't exceed the max (combined share)
        if (paymentType === 'client_pays') {
            const combinedShareMax = parseFloat(amountInput.getAttribute('data-combined-share')) || 0;
            const maxAmount = parseFloat(amountInput.max);
            
            // If combined share is set and > 0, user can only pay up to combined share
            if (combinedShareMax > 0 && amount > combinedShareMax) {
                alert(`You can only pay up to ₹${combinedShareMax.toFixed(2)} (Combined Share: My Share + Company Share). This is the only amount payable.`);
                event.preventDefault();
                return false;
            } else if (maxAmount > 0 && amount > maxAmount) {
                alert(`Amount cannot exceed ₹${maxAmount.toFixed(2)}`);
                event.preventDefault();
                return false;
            }
        }
        
        // Validate date
        if (!date) {
            alert('Please select a date');
            event.preventDefault();
            return false;
        }
        
        // Validate client and exchange IDs
        if (!clientId || !clientExchangeId) {
            alert('Missing client or exchange information. Please try again.');
            event.preventDefault();
            return false;
        }
        
        // Ensure client_type is set - use existing value first, then URL, then 'all'
        let hiddenInput = document.querySelector('input[name="client_type"]');
        let clientType = 'all';
        
        // First, try to get from existing hidden input (set by template)
        if (hiddenInput && hiddenInput.value) {
            clientType = hiddenInput.value;
            console.log('Using client_type from form:', clientType);
        } else {
            // If not in form, get from URL
        const urlParams = new URLSearchParams(window.location.search);
            clientType = urlParams.get('client_type') || 'all';
            console.log('Using client_type from URL:', clientType);
            
            // Create or update the hidden input
        if (!hiddenInput) {
            hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'client_type';
            hiddenInput.id = 'settle-client-type';
            document.getElementById('settlement-form-content').appendChild(hiddenInput);
        }
        hiddenInput.value = clientType;
        }
        
        console.log('Final client_type for form submission:', clientType);
        
        // Ensure report_type is set
        const reportType = urlParams.get('report_type') || 'daily';
        let reportTypeInput = document.querySelector('input[name="report_type"]');
        if (reportTypeInput) {
            reportTypeInput.value = reportType;
        }
        
        // Remove max attribute to prevent HTML5 validation from blocking submission
        // We're doing our own validation above
        const maxAttr = amountInput.getAttribute('max');
        if (maxAttr) {
            amountInput.removeAttribute('max');
        }
        
        const confirmMsg = paymentType === 'admin_pays_profit' 
            ? `Are you sure you want to pay ₹${amount.toFixed(2)} to the client?`
            : `Are you sure you want to record a payment of ₹${amount.toFixed(2)}?`;
        
        if (!confirm(confirmMsg)) {
            // Restore max attribute if user cancels
            if (maxAttr) {
                amountInput.setAttribute('max', maxAttr);
            }
            event.preventDefault();
            return false;
        }
        
        // Debug: Log form data before submission (form already declared at function start)
        console.log('Submitting payment form:', {
            clientId: clientId,
            clientExchangeId: clientExchangeId,
            amount: amount,
            paymentType: paymentType,
            date: date,
            formAction: form.action,
            formMethod: form.method
        });
        
        // Verify form action is set - if not, set it based on client type from URL
        if (!form || !form.action || form.action === '' || form.action === '#') {
            console.warn('Form action not set, attempting to set it now...');
            const urlParams = new URLSearchParams(window.location.search);
            const clientType = urlParams.get('client_type') || 'my';
            const isCompanyClient = clientType === 'company';
            
            // Get URLs from data attributes
            const companyClientsUrl = form.getAttribute('data-company-clients-url');
            const myClientsUrl = form.getAttribute('data-my-clients-url');
            
            if (isCompanyClient && companyClientsUrl) {
                form.action = companyClientsUrl;
                console.log('Set form action to company clients (fallback):', companyClientsUrl);
            } else if (myClientsUrl) {
                form.action = myClientsUrl;
                console.log('Set form action to my clients (fallback):', myClientsUrl);
            } else {
                console.error('Form action not set and cannot determine URL!', {
                    form: form,
                    clientType: clientType,
                    companyClientsUrl: companyClientsUrl,
                    myClientsUrl: myClientsUrl
                });
                alert('Error: Form action is not set. Please refresh the page and try again.');
                event.preventDefault();
                return false;
            }
        }
        
        console.log('Form validation passed, submitting to:', form.action);
        
        // Log all form fields for debugging
        const formData = new FormData(form);
        const formDataObj = {};
        for (let [key, value] of formData.entries()) {
            formDataObj[key] = value;
        }
        console.log('Final form data being submitted:', formDataObj);
        
        // Double-check form action is set
        if (!form.action || form.action === '' || form.action === '#') {
            console.error('CRITICAL: Form action still not set after fallback!');
            alert('Error: Unable to submit form. Please refresh the page and try again.');
            event.preventDefault();
            return false;
        }
        
        // Form will submit normally - don't prevent default
        console.log('Allowing form submission to:', form.action);
        return true;
    }
    
    // Close modal when clicking outside (on overlay)
    document.getElementById('settlement-form').addEventListener('click', function(e) {
        // Only close if clicking directly on the overlay, not on the form content
        if (e.target === this) {
            hideSettlementForm();
        }
    });
    
    // Prevent form content clicks from closing the modal
    document.getElementById('settlement-form-content').addEventListener('click', function(e) {
        e.stopPropagation();
    });
</script>

<script>
    function showSection(sectionId) {
        // Prevent any zoom effects
        const container = document.querySelector('.pending-container');
        if (container) {
            container.style.transform = 'scale(1)';
            container.style.zoom = '1';
        }
        
        // Hide all sections instantly without any effects
        document.querySelectorAll('.section-content').forEach(section => {
            section.style.display = 'none';
            section.style.transform = 'scale(1)';
        });
        
        // Remove active class from all tabs
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
        });
        
        // Show selected section instantly
        const targetSection = document.getElementById('section-' + sectionId);
        targetSection.style.display = 'block';
        targetSection.style.transform = 'scale(1)';
        
        // Add active class to clicked tab
        const activeButton = document.getElementById('tab-' + sectionId);
        activeButton.classList.add('active');
        
        // Update URL without reloading page (use replaceState to prevent scroll/zoom)
        const url = new URL(window.location);
        url.searchParams.set('section', sectionId);
        const reportType = url.searchParams.get('report_type') || 'daily';
        url.searchParams.set('report_type', reportType);
        // Preserve client_type filter
        const clientType = url.searchParams.get('client_type') || '';
        if (clientType) {
            url.searchParams.set('client_type', clientType);
        }
        window.history.replaceState({}, '', url);
        
        // Update hidden input in form
        document.getElementById('section-param').value = sectionId;
        
        // Force reflow to prevent zoom
        void container.offsetHeight;
    }
    
    // Set initial active tab based on URL parameter or default to first
    window.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const section = urlParams.get('section');
        if (section === 'you-owe') {
            showSection('you-owe');
        } else {
            showSection('clients-owe');
        }
        
        // Sync checkboxes if both exist
        const checkboxClients = document.getElementById('combine-shares-toggle-clients');
        const checkboxYouOwe = document.getElementById('combine-shares-toggle');
        // Check URL parameter first, then fall back to Django template variable
        const urlCombineShares = urlParams.get('combine_shares');
        const djangoCombineShares = {% if combine_shares %}true{% else %}false{% endif %};
        // Use URL parameter if present, otherwise use Django template variable (defaults to true)
        const combineShares = urlCombineShares !== null ? (urlCombineShares === 'true') : djangoCombineShares;
        
        if (checkboxClients) {
            checkboxClients.checked = combineShares;
        }
        if (checkboxYouOwe) {
            checkboxYouOwe.checked = combineShares;
        }
        
        // Initialize table columns based on current state - ensure columns are visible
        updateTableColumns(combineShares);
    });
    
    // Toggle combine shares view - smooth and instant without page reload
    function toggleCombineShares(clickedCheckbox) {
        if (!clickedCheckbox) {
            const checkboxClients = document.getElementById('combine-shares-toggle-clients');
            const checkboxYouOwe = document.getElementById('combine-shares-toggle');
            clickedCheckbox = checkboxClients || checkboxYouOwe;
        }
        
        if (!clickedCheckbox) return;
        
        const combineShares = clickedCheckbox.checked;
        
        // Update the other checkbox if it exists (to keep them in sync)
        const checkboxClients = document.getElementById('combine-shares-toggle-clients');
        const checkboxYouOwe = document.getElementById('combine-shares-toggle');
        if (checkboxClients && checkboxYouOwe) {
            checkboxClients.checked = combineShares;
            checkboxYouOwe.checked = combineShares;
        }
        
        // Update table headers and cells instantly without reload
        updateTableColumns(combineShares);
        
        // Update URL without reload (for bookmarking/sharing)
        const url = new URL(window.location);
        if (combineShares) {
            url.searchParams.set('combine_shares', 'true');
        } else {
            url.searchParams.delete('combine_shares');
        }
        window.history.replaceState({}, '', url);
    }
    
    // Update table columns dynamically - smooth and instant
    function updateTableColumns(combineShares) {
        // Update both tables
        ['#section-clients-owe table', '#section-you-owe table'].forEach(selector => {
            const table = document.querySelector(selector);
            if (!table) return;
            
            // Update headers
            const myShareHeader = table.querySelector('.my-share-header');
            const companyShareHeader = table.querySelector('.company-share-header');
            const combinedShareHeader = table.querySelector('.combined-share-header');
            
            if (combineShares) {
                // Show combined, hide separate
                if (myShareHeader) myShareHeader.style.display = 'none';
                if (companyShareHeader) companyShareHeader.style.display = 'none';
                if (combinedShareHeader) combinedShareHeader.style.display = '';
            } else {
                // Show separate, hide combined
                if (myShareHeader) myShareHeader.style.display = '';
                if (companyShareHeader) companyShareHeader.style.display = '';
                if (combinedShareHeader) combinedShareHeader.style.display = 'none';
            }
            
            // Update body cells
            const myShareCells = table.querySelectorAll('.my-share-cell');
            const companyShareCells = table.querySelectorAll('.company-share-cell');
            const combinedShareCells = table.querySelectorAll('.combined-share-cell');
            
            myShareCells.forEach((cell, index) => {
                const myShare = parseFloat(cell.dataset.myShare || 0);
                const companyShare = parseFloat(cell.dataset.companyShare || 0);
                const combinedShare = parseFloat(cell.dataset.combinedShare || 0);
                
                if (combineShares) {
                    // Hide separate columns, show combined
                    cell.style.display = 'none';
                    if (companyShareCells[index]) {
                        companyShareCells[index].style.display = 'none';
                    }
                    if (combinedShareCells[index]) {
                        combinedShareCells[index].style.display = '';
                        combinedShareCells[index].innerHTML = `<span class="amount-value">₹ ${combinedShare.toFixed(1)}</span>`;
                    }
                } else {
                    // Show separate columns, hide combined
                    cell.style.display = '';
                    cell.innerHTML = `<span class="amount-value">₹ ${myShare.toFixed(1)}</span>`;
                    if (companyShareCells[index]) {
                        companyShareCells[index].style.display = '';
                        companyShareCells[index].innerHTML = `<span class="amount-value">₹ ${companyShare.toFixed(1)}</span>`;
                    }
                    if (combinedShareCells[index]) {
                        combinedShareCells[index].style.display = 'none';
                    }
                }
            });
        });
    }
</script>
</div>
{% endblock %}
