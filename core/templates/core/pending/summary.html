{% extends "core/base.html" %}

{% block title %}Pending Payments · Broker Portal{% endblock %}
{% block page_title %}Pending Payments{% endblock %}
{% block page_subtitle %}Two separate sections: Clients owe you vs You owe clients{% endblock %}

{% block content %}
<style>
    * {
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
    }
    
    .pending-container {
        max-width: 1400px;
        margin: 0 auto;
        transform: scale(1) !important;
        zoom: 1 !important;
        -webkit-transform: scale(1) !important;
    }
    
    .alert-message {
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        background: #ffffff;
        color: #111827;
        border-left: 3px solid #6b7280;
        font-size: 14px;
        line-height: 1.6;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .tabs-container {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        background: transparent;
        padding: 0;
    }
    
    .tab-button {
        padding: 12px 28px;
        background: #ffffff;
        color: #6b7280;
        border: 1px solid #e5e7eb;
        border-radius: 8px 8px 0 0;
        border-bottom: none;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }
    
    .tab-button:hover {
        background: #f9fafb;
        color: #374151;
    }
    
    .tab-button.active {
        background: #ffffff;
        color: #111827;
        font-weight: 600;
        border-bottom: 2px solid #ffffff;
        margin-bottom: -1px;
    }
    
    .section-content {
        background: #ffffff;
        border-radius: 8px;
        padding: 28px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        border: 1px solid #e5e7eb;
        transition: none !important;
        transform: scale(1) !important;
        -webkit-transform: scale(1) !important;
        will-change: auto;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
    }
    
    .section-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
        color: #111827;
        letter-spacing: -0.01em;
        padding-bottom: 12px;
        border-bottom: 1px solid #f3f4f6;
    }
    
    .summary-card {
        background: linear-gradient(to right, #f9fafb, #ffffff);
        border-radius: 8px;
        padding: 20px 24px;
        margin-bottom: 24px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    
    .summary-amount {
        font-size: 28px;
        font-weight: 700;
        color: #111827;
        margin-bottom: 6px;
        letter-spacing: -0.01em;
    }
    
    .summary-note {
        font-size: 13px;
        color: #6b7280;
        line-height: 1.5;
    }
    
    .table-container {
        background: #ffffff;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        overflow: hidden;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    
    .table-header-info {
        padding: 14px 20px;
        border-bottom: 1px solid #e5e7eb;
        background: #fafafa;
        font-size: 13px;
        color: #6b7280;
        font-weight: 500;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .data-table thead {
        background: #f9fafb;
    }
    
    .data-table th {
        padding: 14px 20px;
        text-align: left;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: #6b7280;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .data-table td {
        padding: 16px 20px;
        border-bottom: 1px solid #f3f4f6;
        font-size: 14px;
        color: #111827;
    }
    
    .data-table tbody tr:hover {
        background: #f9fafb;
    }
    
    .data-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    .client-link {
        color: #111827;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s;
    }
    
    .client-link:hover {
        color: #374151;
        text-decoration: underline;
    }
    
    .amount-value {
        font-size: 15px;
        font-weight: 600;
        color: #111827;
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        letter-spacing: 0.02em;
    }
    
    .action-button {
        padding: 7px 14px;
        background: #111827;
        color: #ffffff;
        border: none;
        border-radius: 5px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    
    .action-button:hover {
        background: #374151;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #9ca3af;
        font-size: 15px;
    }
    
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
    }
    
    .modal-content {
        background: #ffffff;
        border-radius: 10px;
        padding: 28px;
        border: 1px solid #e5e7eb;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 14px;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: #111827;
        margin: 0;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #6b7280;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s;
    }
    
    .modal-close:hover {
        background: #f3f4f6;
        color: #111827;
    }
    
    .form-group {
        margin-bottom: 18px;
    }
    
    .form-label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 8px;
    }
    
    .form-input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 6px;
        border: 1px solid #d1d5db;
        background: #ffffff;
        color: #111827;
        font-size: 14px;
        transition: all 0.2s;
    }
    
    .form-input:focus {
        outline: none;
        border-color: #111827;
        box-shadow: 0 0 0 2px rgba(17, 24, 39, 0.08);
    }
    
    .form-input[readonly] {
        background: #f9fafb;
        color: #6b7280;
    }
    
    .form-help {
        font-size: 12px;
        color: #6b7280;
        margin-top: 6px;
        line-height: 1.4;
    }
    
    .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 24px;
        padding-top: 18px;
        border-top: 1px solid #e5e7eb;
    }
    
    .btn-primary {
        flex: 1;
        padding: 10px 18px;
        background: #111827;
        color: #ffffff;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-primary:hover {
        background: #374151;
    }
    
    .btn-secondary {
        padding: 10px 18px;
        background: #ffffff;
        color: #374151;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-secondary:hover {
        background: #f9fafb;
        border-color: #9ca3af;
    }
</style>

<div class="pending-container">
{% if messages %}
    <div>
        {% for message in messages %}
            <div class="alert-message">
                {{ message }}
            </div>
        {% endfor %}
    </div>
        {% endif %}

<!-- Client Type Filter -->
<div style="margin-bottom: 20px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
    <span style="font-size: 14px; font-weight: 500; color: #374151; margin-right: 8px;">Filter by Client Type:</span>
    <a href="?section={% if request.GET.section %}{{ request.GET.section }}{% else %}clients-owe{% endif %}&report_type={{ report_type }}" 
       class="tab-button {% if not client_type_filter %}active{% endif %}" 
       style="text-decoration: none; display: inline-block;">
        All Clients
    </a>
    <a href="?section={% if request.GET.section %}{{ request.GET.section }}{% else %}clients-owe{% endif %}&report_type={{ report_type }}&client_type=my" 
       class="tab-button {% if client_type_filter == 'my' %}active{% endif %}" 
       style="text-decoration: none; display: inline-block;">
        My Clients
    </a>
    <a href="?section={% if request.GET.section %}{{ request.GET.section }}{% else %}clients-owe{% endif %}&report_type={{ report_type }}&client_type=company" 
       class="tab-button {% if client_type_filter == 'company' %}active{% endif %}" 
       style="text-decoration: none; display: inline-block;">
        Company Clients
    </a>
</div>

<!-- Tab Headers -->
<div class="tabs-container">
    <button onclick="showSection('clients-owe')" id="tab-clients-owe" class="tab-button active">
        Clients Owe You
    </button>
    <button onclick="showSection('you-owe')" id="tab-you-owe" class="tab-button">
        You Owe Clients
    </button>
</div>

<div id="section-clients-owe" class="section-content" style="display: block;">
    <h2 class="section-title">
        Clients Owe You (Pending Amount - Unpaid Losses)
    </h2>
    {% if total_pending %}
    <div class="summary-card">
        <div class="summary-amount">
            Total Pending: ₹ {{ total_pending|floatformat:2 }}
        </div>
        <div class="summary-note">
            Pending is a separate ledger - only affected by losses and client payments
        </div>
    </div>
    {% endif %}
    <div class="table-container">
        <div class="table-header-info">
            Total clients: {{ clients_owe|length }}
        </div>
        <table class="data-table">
            <thead>
            <tr>
                <th>Client Code</th>
                <th>Client Name</th>
                <th>Exchange</th>
                <th>Total Funding</th>
                <th>Exchange Balance</th>
                <th>Pending Amount</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for item in clients_owe %}
                <tr>
                    <td><strong>{% if item.client_code %}{{ item.client_code }}{% else %}<span style="color: #9ca3af;">—</span>{% endif %}</strong></td>
                    <td>
                        <a href="{% url 'clients:balance' item.client_id %}?exchange={{ item.client_exchange_id }}" class="client-link">
                            {{ item.client_name }}
                        </a>
                    </td>
                    <td>{{ item.exchange_name }}</td>
                    <td>₹ {{ item.total_funding|floatformat:2 }}</td>
                    <td>₹ {{ item.exchange_balance|floatformat:2 }}</td>
                    <td><span class="amount-value">₹ {{ item.pending_amount|floatformat:2 }}</span></td>
                    <td>
                        <button onclick="showSettlementForm({{ item.client_id }}, {{ item.client_exchange_id }}, '{{ item.client_name }}', '{{ item.exchange_name }}', {{ item.pending_amount }}, 'client_pays')" class="action-button">
                            Record Payment
                        </button>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="7" class="empty-state">No pending amounts for the selected period.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="section-you-owe" class="section-content" style="display: none;">
    <h2 class="section-title">
        You Owe Clients (Clients in Profit)
    </h2>
    {% if total_profit %}
    <div class="summary-card">
        <div class="summary-amount">
            Total Profit: ₹ {{ total_profit|floatformat:2 }}
        </div>
        <div class="summary-note">
            Profit payment does NOT affect pending amount (separate ledger)
        </div>
    </div>
    {% endif %}
    <div class="table-container">
        <div class="table-header-info">
            Total clients: {{ you_owe|length }}
        </div>
        <table class="data-table">
            <thead>
            <tr>
                <th>Client Code</th>
                <th>Client Name</th>
                <th>Exchange</th>
                <th>Total Funding</th>
                <th>Exchange Balance</th>
                <th>My Share</th>
                <th>Company Share</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for item in you_owe %}
                <tr>
                    <td><strong>{% if item.client_code %}{{ item.client_code }}{% else %}<span style="color: #9ca3af;">—</span>{% endif %}</strong></td>
                    <td>
                        <a href="{% url 'clients:balance' item.client_id %}?exchange={{ item.client_exchange_id }}" class="client-link">
                            {{ item.client_name }}
                        </a>
                    </td>
                    <td>{{ item.exchange_name }}</td>
                    <td>₹ {{ item.total_funding|floatformat:2 }}</td>
                    <td>₹ {{ item.exchange_balance|floatformat:2 }}</td>
                    <td><span class="amount-value">₹ {{ item.my_share|default:0|floatformat:2 }}</span></td>
                    <td><span class="amount-value">₹ {{ item.company_share|default:0|floatformat:2 }}</span></td>
                    <td>
                        <button onclick="showSettlementForm({{ item.client_id }}, {{ item.client_exchange_id }}, '{{ item.client_name }}', '{{ item.exchange_name }}', {{ item.client_profit }}, 'admin_pays_profit')" class="action-button">
                            Pay Profit
                        </button>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="8" class="empty-state">You don't owe any clients for the selected period.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Settlement Form Modal -->
<div id="settlement-form" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Settle Payment</h2>
            <button onclick="hideSettlementForm()" class="modal-close">&times;</button>
        </div>
        <form method="post" action="{% url 'clients:settle_payment' %}" id="settlement-form-content" onsubmit="return handleFormSubmit(event);">
            {% csrf_token %}
            <input type="hidden" name="client_id" id="settle-client-id">
            <input type="hidden" name="client_exchange_id" id="settle-client-exchange-id">
            <input type="hidden" name="payment_type" id="settle-payment-type" value="client_pays">
            <input type="hidden" name="report_type" value="{{ report_type }}">
            <input type="hidden" name="section" id="section-param" value="clients-owe">
            
            <div class="form-group">
                <label class="form-label">Client</label>
                <input type="text" id="settle-client-name" class="form-input" readonly>
            </div>
            
            <div class="form-group">
                <label class="form-label">Exchange</label>
                <input type="text" id="settle-exchange-name" class="form-input" readonly>
            </div>
            
            <div class="form-group">
                <label class="form-label">Amount to Pay (₹) *</label>
                <input type="number" name="amount" id="settle-amount" class="form-input" step="0.01" min="0" required placeholder="0.00">
                <div id="pending-info" class="form-help" style="display: none;">
                    <span id="pending-amount-text"></span> - You can pay any amount (partial or full)
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Date *</label>
                <input type="date" name="date" class="form-input" value="{% now 'Y-m-d' %}" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Note (Optional)</label>
                <textarea name="note" class="form-input" rows="3" placeholder="Add any notes about this settlement" style="resize: vertical;"></textarea>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn-primary">Pay Client</button>
                <button type="button" onclick="hideSettlementForm()" class="btn-secondary">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    function showSettlementForm(clientId, clientExchangeId, clientName, exchangeName, amount, paymentType) {
        document.getElementById('settle-client-id').value = clientId;
        document.getElementById('settle-client-exchange-id').value = clientExchangeId;
        document.getElementById('settle-client-name').value = clientName;
        document.getElementById('settle-exchange-name').value = exchangeName;
        document.getElementById('settle-amount').value = parseFloat(amount).toFixed(2);
        document.getElementById('settle-payment-type').value = paymentType || 'client_pays';
        
        // Preserve client_type filter in form
        const urlParams = new URLSearchParams(window.location.search);
        const clientType = urlParams.get('client_type');
        const form = document.getElementById('settlement-form-content');
        let hiddenInput = document.getElementById('settle-client-type');
        if (clientType) {
            if (!hiddenInput) {
                hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'client_type';
                hiddenInput.id = 'settle-client-type';
                form.appendChild(hiddenInput);
            }
            hiddenInput.value = clientType;
        } else if (hiddenInput) {
            hiddenInput.remove();
        }
        
        // Update form title and button text based on payment type
        const formTitle = document.querySelector('.modal-title');
        const submitButton = document.querySelector('.btn-primary');
        const pendingInfo = document.getElementById('pending-info');
        const pendingAmountText = document.getElementById('pending-amount-text');
        const amountInput = document.getElementById('settle-amount');
        
        if (paymentType === 'admin_pays_profit') {
            formTitle.textContent = 'Pay Client Profit';
            submitButton.textContent = 'Pay Client';
            pendingInfo.style.display = 'none';
            amountInput.max = '';
        } else {
            formTitle.textContent = 'Record Client Payment (Partial or Full)';
            submitButton.textContent = 'Record Payment';
            pendingInfo.style.display = 'block';
            pendingAmountText.textContent = 'Pending Amount: ₹' + parseFloat(amount).toFixed(2);
            amountInput.max = parseFloat(amount).toFixed(2);
            amountInput.placeholder = 'Enter amount (up to ₹' + parseFloat(amount).toFixed(2) + ')';
        }
        
        document.getElementById('settlement-form').style.display = 'flex';
    }
    
    function hideSettlementForm() {
        document.getElementById('settlement-form').style.display = 'none';
    }
    
    function handleFormSubmit(event) {
        const amount = parseFloat(document.getElementById('settle-amount').value);
        const paymentType = document.getElementById('settle-payment-type').value;
        
        if (!amount || amount <= 0) {
            alert('Please enter a valid amount greater than 0');
            event.preventDefault();
            return false;
        }
        
        const confirmMsg = paymentType === 'admin_pays_profit' 
            ? `Are you sure you want to pay ₹${amount.toFixed(2)} to the client?`
            : `Are you sure you want to record a payment of ₹${amount.toFixed(2)}?`;
        
        if (!confirm(confirmMsg)) {
            event.preventDefault();
            return false;
        }
        
        return true;
    }
    
    document.getElementById('settlement-form').addEventListener('click', function(e) {
        if (e.target === this) {
            hideSettlementForm();
        }
    });
</script>

<script>
    function showSection(sectionId) {
        // Prevent any zoom effects
        const container = document.querySelector('.pending-container');
        if (container) {
            container.style.transform = 'scale(1)';
            container.style.zoom = '1';
        }
        
        // Hide all sections instantly without any effects
        document.querySelectorAll('.section-content').forEach(section => {
            section.style.display = 'none';
            section.style.transform = 'scale(1)';
        });
        
        // Remove active class from all tabs
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
        });
        
        // Show selected section instantly
        const targetSection = document.getElementById('section-' + sectionId);
        targetSection.style.display = 'block';
        targetSection.style.transform = 'scale(1)';
        
        // Add active class to clicked tab
        const activeButton = document.getElementById('tab-' + sectionId);
        activeButton.classList.add('active');
        
        // Update URL without reloading page (use replaceState to prevent scroll/zoom)
        const url = new URL(window.location);
        url.searchParams.set('section', sectionId);
        const reportType = url.searchParams.get('report_type') || 'daily';
        url.searchParams.set('report_type', reportType);
        // Preserve client_type filter
        const clientType = url.searchParams.get('client_type') || '';
        if (clientType) {
            url.searchParams.set('client_type', clientType);
        }
        window.history.replaceState({}, '', url);
        
        // Update hidden input in form
        document.getElementById('section-param').value = sectionId;
        
        // Force reflow to prevent zoom
        void container.offsetHeight;
    }
    
    // Set initial active tab based on URL parameter or default to first
    window.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const section = urlParams.get('section');
        if (section === 'you-owe') {
            showSection('you-owe');
        } else {
            showSection('clients-owe');
        }
    });
</script>
</div>
{% endblock %}
