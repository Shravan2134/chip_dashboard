{% extends "core/base.html" %}

{% block title %}Account · {{ account.client.name }} - {{ account.exchange.name }}{% endblock %}
{% block page_title %}{{ account.client.name }} - {{ account.exchange.name }}{% endblock %}
{% block page_subtitle %}Account details and transactions{% endblock %}

{% block page_actions %}
<div style="display: flex; gap: 10px; flex-wrap: wrap;">
    <a href="{% url 'add_funding' account.pk %}" class="btn btn-primary">Add Funding</a>
    <a href="{% url 'update_balance' account.pk %}" class="btn btn-primary">Update Balance</a>
    {% with settlement_info=account.get_remaining_settlement_amount %}
        {% if settlement_info.remaining > 0 %}
            <a href="{% url 'record_payment' account.pk %}" class="btn" style="background: #fef3c7; color: #92400e;">Record Payment</a>
        {% endif %}
    {% endwith %}
    <a href="{% url 'client_detail' account.client.pk %}" class="btn">Back to Client</a>
</div>
{% endblock %}

{% block content %}
{% with pnl=account.compute_client_pnl share=account.compute_my_share remaining=account.get_remaining_settlement_amount %}
<!-- Account Summary Cards -->
<div class="card-grid" style="margin-bottom: 24px;">
    <div class="card">
        <div class="card-title">Funding</div>
        <div class="card-value">{{ account.funding|floatformat:0 }}</div>
    </div>
    <div class="card">
        <div class="card-title">Exchange Balance</div>
        <div class="card-value">{{ account.exchange_balance|floatformat:0 }}</div>
    </div>
    <div class="card">
        <div class="card-title">Client PnL</div>
        <div class="card-value {% if pnl > 0 %}positive{% elif pnl < 0 %}negative{% endif %}">
            {{ pnl|floatformat:0 }}
        </div>
    </div>
    <div class="card">
        <div class="card-title">Final Share</div>
        <div class="card-value">
            {% if share == 0 %}
                <span style="color: var(--muted);">N.A (Zero Share)</span>
            {% else %}
                {{ share|floatformat:0 }}
            {% endif %}
        </div>
    </div>
    <div class="card">
        <div class="card-title">Remaining Settlement</div>
        <div class="card-value">
            {% if share == 0 %}
                <span style="color: var(--muted);">N.A</span>
            {% else %}
                <strong style="color: var(--accent);">{{ remaining|floatformat:0 }}</strong>
            {% endif %}
        </div>
    </div>
    <div class="card">
        <div class="card-title">Share Percentage</div>
        <div class="card-value">
            {% if pnl < 0 %}
                {{ account.loss_share_percentage|default:account.my_percentage }}% (Loss)
            {% elif pnl > 0 %}
                {{ account.profit_share_percentage|default:account.my_percentage }}% (Profit)
            {% else %}
                {{ account.my_percentage }}%
            {% endif %}
        </div>
    </div>
    <div class="card">
        <div class="card-title">Settlement Status</div>
        <div class="card-value">
            {% if pnl == 0 %}
                <span style="color: #10b981; font-weight: 600;">✓ Trading Flat (PnL = 0)</span>
            {% elif share == 0 %}
                <span style="color: #6b7280; font-weight: 600;">N.A (Zero Share)</span>
            {% elif remaining == 0 %}
                <span style="color: #10b981; font-weight: 600;">✓ Settlement Complete</span>
            {% else %}
                <span style="color: #f59e0b; font-weight: 600;">⚠ Action Required</span>
            {% endif %}
        </div>
    </div>
</div>

<!-- Account Information -->
<div style="background: var(--bg-content); border-radius: 8px; padding: 24px; border: 1px solid var(--border); margin-bottom: 24px;">
    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Account Information</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
        <div>
            <div style="font-size: 13px; color: var(--muted); margin-bottom: 4px;">Client</div>
            <div style="font-weight: 500;">
                <a href="{% url 'client_detail' account.client.pk %}" style="color: var(--accent); text-decoration: none;">
                    {{ account.client.name }}{% if account.client.code %} ({{ account.client.code }}){% endif %}
                </a>
            </div>
        </div>
        <div>
            <div style="font-size: 13px; color: var(--muted); margin-bottom: 4px;">Exchange</div>
            <div style="font-weight: 500;">
                {{ account.exchange.name }}{% if account.exchange.code %} ({{ account.exchange.code }}){% endif %}
            </div>
        </div>
        <div>
            <div style="font-size: 13px; color: var(--muted); margin-bottom: 4px;">Created</div>
            <div style="font-weight: 500;">{{ account.created_at|date:"M d, Y" }}</div>
        </div>
        <div>
            <div style="font-size: 13px; color: var(--muted); margin-bottom: 4px;">Last Updated</div>
            <div style="font-weight: 500;">{{ account.updated_at|date:"M d, Y" }}</div>
        </div>
    </div>
</div>

<!-- Report Configuration (if exists) -->
{% if account.report_config %}
<div style="background: var(--bg-content); border-radius: 8px; padding: 24px; border: 1px solid var(--border); margin-bottom: 24px;">
    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Report Configuration</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
        <div>
            <div style="font-size: 13px; color: var(--muted); margin-bottom: 4px;">Friend %</div>
            <div style="font-weight: 500;">{{ account.report_config.friend_percentage }}%</div>
        </div>
        <div>
            <div style="font-size: 13px; color: var(--muted); margin-bottom: 4px;">My Own %</div>
            <div style="font-weight: 500;">{{ account.report_config.my_own_percentage }}%</div>
        </div>
    </div>
    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 13px; color: var(--muted);">
        <strong>Note:</strong> These percentages are used ONLY for reports, not system logic.
    </div>
</div>
{% endif %}

<!-- Settlements (MASKED SHARE SETTLEMENT SYSTEM) -->
{% if settlements %}
<div style="background: var(--bg-content); border-radius: 8px; padding: 0; border: 1px solid var(--border); overflow: hidden; margin-bottom: 24px;">
    <div class="table-header">
        <span>Settlement History</span>
        <span class="pill">Total Settled: {{ total_settled|floatformat:0 }} / {{ final_share|floatformat:0 }}</span>
    </div>
    <div class="table-wrapper" style="border: none; box-shadow: none;">
        <table>
            <thead>
            <tr>
                <th>Date</th>
                <th>Amount</th>
                <th>Notes</th>
            </tr>
            </thead>
            <tbody>
            {% for settlement in settlements %}
            <tr>
                <td>{{ settlement.date|date:"M d, Y H:i" }}</td>
                <td><strong>{{ settlement.amount|floatformat:0 }}</strong></td>
                <td style="color: var(--muted); font-size: 13px;">{{ settlement.notes|truncatewords:10|default:"—" }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Recent Transactions -->
<div style="background: var(--bg-content); border-radius: 8px; padding: 0; border: 1px solid var(--border); overflow: hidden;">
    <div class="table-header">
        <span>Recent Transactions</span>
        <a href="{% url 'transaction_list' %}?client_exchange={{ account.pk }}" class="btn btn-sm" style="margin-left: auto;">View All</a>
    </div>
    <div class="table-wrapper" style="border: none; box-shadow: none;">
        {% if transactions %}
        <table>
            <thead>
            <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Exchange Balance After</th>
                <th>Notes</th>
            </tr>
            </thead>
            <tbody>
            {% for tx in transactions %}
            <tr>
                <td>{{ tx.date|date:"M d, Y" }}</td>
                <td>
                    <span class="badge" style="background: {% if tx.type == 'FUNDING' %}#dbeafe{% elif tx.type == 'TRADE' %}#e0e7ff{% elif tx.type == 'FEE' %}#fce7f3{% elif tx.type == 'RECORD_PAYMENT' %}#fef3c7{% else %}#f3f4f6{% endif %}; color: {% if tx.type == 'FUNDING' %}#1e40af{% elif tx.type == 'TRADE' %}#4338ca{% elif tx.type == 'FEE' %}#be185d{% elif tx.type == 'RECORD_PAYMENT' %}#92400e{% else %}#374151{% endif %};">
                        {{ tx.get_type_display }}
                    </span>
                </td>
                <td>{{ tx.amount|floatformat:0 }}</td>
                <td>{{ tx.exchange_balance_after|floatformat:0 }}</td>
                <td style="color: var(--muted); font-size: 13px;">{{ tx.notes|truncatewords:10|default:"—" }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div style="padding: 40px; text-align: center; color: var(--muted);">
            <div style="font-size: 16px; margin-bottom: 8px;">No Transactions</div>
            <div style="font-size: 14px;">Start by adding funding or updating the exchange balance.</div>
        </div>
        {% endif %}
    </div>
</div>
{% endwith %}
{% endblock %}

