{% extends "core/base.html" %}

{% block title %}Edit Exchange Link · Transaction Hub{% endblock %}
{% block page_title %}Edit Exchange Configuration{% endblock %}
{% block page_subtitle %}{{ client_exchange.exchange.name }} for {{ client_exchange.client.name }}{% endblock %}

{% block content %}
<div style="background: var(--bg-content); border-radius: 8px; padding: 24px; border: 1px solid var(--border); max-width: 600px;">
    <form method="post">
        {% csrf_token %}
        <div class="form-row">
            <label class="field-label">Exchange 
                {% if can_edit_exchange %}
                    <span style="color: var(--success); font-weight: normal;">(Editable - Created {{ days_since_creation }} day{{ days_since_creation|pluralize }} ago)</span>
                {% else %}
                    <span style="color: var(--muted); font-weight: normal;">(Cannot be changed)</span>
                {% endif %}
            </label>
            {% if can_edit_exchange %}
                <select name="exchange" class="field-input" required>
                    {% for exchange in exchanges %}
                        <option value="{{ exchange.pk }}" {% if exchange.pk == client_exchange.exchange.pk %}selected{% endif %}>
                            {{ exchange.name }}{% if exchange.code %} ({{ exchange.code }}){% endif %}
                        </option>
                    {% endfor %}
                </select>
                <div style="font-size: 12px; color: var(--success); margin-top: 4px;">
                    You can change the exchange within 10 days of creation. {{ days_remaining }} day{{ days_remaining|pluralize }} remaining.
                </div>
            {% else %}
                <input type="text" class="field-input" value="{{ client_exchange.exchange.name }}{% if client_exchange.exchange.code %} ({{ client_exchange.exchange.code }}){% endif %}" disabled style="background-color: #f3f4f6; color: #6b7280; cursor: not-allowed; opacity: 0.7;">
                <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
                    Exchange cannot be modified after 10 days from creation. To change the exchange, delete this link and create a new one.
                </div>
            {% endif %}
        </div>
        
        <div class="form-row">
            <label class="field-label">My Share % (Your share of profits) *</label>
            <input type="number" name="my_share_pct" id="my-share-input" class="field-input" step="0.01" min="0" max="100" value="{{ client_exchange.my_share_pct }}" required {% if client_type == 'company' %}oninput="validateCompanyShare()"{% endif %}>
            <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">Your percentage share of profits</div>
        </div>
        
        {% if client_type == 'company' %}
        <div class="form-row">
            <label class="field-label">Company Share % (From CLIENT's share) *</label>
            <input type="number" name="company_share_pct" id="company-share-input" class="field-input" step="0.01" min="0" max="100" value="{{ client_exchange.company_share_pct }}" required oninput="validateCompanyShare(); updateExample()">
            <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
                Percentage of CLIENT's share that company gets. Example: If your share is 30% and company share is 9%, company gets 9% of the client's 70% share.
            </div>
            <div id="example-calculation" style="font-size: 12px; color: var(--accent); margin-top: 4px; font-weight: 500; display: none;"></div>
            <div id="validation-message" style="font-size: 12px; color: var(--danger); margin-top: 4px; display: none;"></div>
            {% if error %}
                <div style="font-size: 12px; color: var(--danger); margin-top: 4px;">{{ error }}</div>
            {% endif %}
        </div>
        {% endif %}
        
        <div class="form-row">
            <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" name="is_active" {% if client_exchange.is_active %}checked{% endif %}>
                <span class="field-label" style="margin: 0;">Active</span>
            </label>
        </div>
        
        <div style="display: flex; gap: 12px; margin-top: 20px;">
            <button type="submit" class="btn btn-primary" id="submit-btn">Save Changes</button>
            <a href="{% if client_type == 'company' %}{% url 'company_clients:detail' client_exchange.client.pk %}{% else %}{% url 'my_clients:detail' client_exchange.client.pk %}{% endif %}" class="btn">Cancel</a>
        </div>
    </form>
</div>

<script>
{% if client_type == 'company' %}
function validateCompanyShare() {
    const companyShareInput = document.getElementById('company-share-input');
    if (!companyShareInput) return;
    
    const companyShare = parseFloat(companyShareInput.value) || 0;
    const messageDiv = document.getElementById('validation-message');
    const submitBtn = document.getElementById('submit-btn');
    
    if (companyShare >= 100) {
        messageDiv.textContent = 'Company share must be less than 100%';
        messageDiv.style.display = 'block';
        submitBtn.disabled = true;
        submitBtn.style.opacity = '0.5';
    } else {
        messageDiv.style.display = 'none';
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
    }
}

function updateExample() {
    const myShareInput = document.getElementById('my-share-input');
    const companyShareInput = document.getElementById('company-share-input');
    const exampleDiv = document.getElementById('example-calculation');
    
    if (!myShareInput || !companyShareInput || !exampleDiv) return;
    
    const myShare = parseFloat(myShareInput.value) || 0;
    const companyShare = parseFloat(companyShareInput.value) || 0;
    
    if (myShare > 0 && companyShare > 0 && companyShare < 100 && myShare < 100) {
        const exampleProfit = 1000;
        const yourProfit = (exampleProfit * myShare) / 100;
        const clientShare = exampleProfit - yourProfit;
        const companyGets = (clientShare * companyShare) / 100;
        const clientKeeps = clientShare - companyGets;
        
        exampleDiv.innerHTML = `Example: If profit is ₹${exampleProfit}, you get ₹${yourProfit.toFixed(2)} (${myShare}%), client gets ₹${clientShare.toFixed(2)} (${100-myShare}%), company gets ₹${companyGets.toFixed(2)} (${companyShare}% of client's ${100-myShare}%), client keeps ₹${clientKeeps.toFixed(2)}`;
        exampleDiv.style.display = 'block';
    } else {
        exampleDiv.style.display = 'none';
    }
}

// Update example when my share changes too
const myShareInput = document.getElementById('my-share-input');
if (myShareInput) {
    myShareInput.addEventListener('input', function() {
        validateCompanyShare();
        updateExample();
    });
}
{% endif %}
</script>
{% endblock %}

