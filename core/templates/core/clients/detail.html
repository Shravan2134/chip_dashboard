{% extends "core/base.html" %}

{% block title %}Client · {{ client.name }}{% endblock %}
{% block page_title %}{{ client.name }}{% endblock %}
{% block page_subtitle %}{% if client.code %}Code: {{ client.code }} · {% endif %}Exchanges and recent activity{% endblock %}

{% block page_actions %}
<a href="{% url 'exchanges:link_to_client' client.pk %}" class="btn btn-primary">Link Exchange</a>
<button onclick="showGiveMoneyForm()" class="btn" style="background: var(--success); color: white;">Give Money</button>
<a href="{% url 'clients:balance' client.pk %}" class="btn">View Balance</a>
<a href="{% url 'clients:report' client.pk %}" class="btn">View Report</a>
{% endblock %}

{% block content %}
<div class="card-grid">
    <div class="card">
        <div class="card-title">Status</div>
        <div class="card-value">
            {% if client.is_active %}
                <span class="badge badge-success">Active</span>
            {% else %}
                <span class="badge badge-muted">Inactive</span>
            {% endif %}
        </div>
    </div>
    <div class="card">
        <div class="card-title">Linked Exchanges</div>
        <div class="card-value">{{ client_exchanges|length }} active, {{ inactive_client_exchanges|length }} inactive</div>
    </div>
</div>

<!-- Active Exchanges Section -->
<div class="mt-4">
    <h2 style="font-size: 22px; font-weight: 600; margin-bottom: 16px; color: var(--text); display: flex; align-items: center; gap: 8px;">
        <span style="width: 4px; height: 24px; background: var(--success); border-radius: 2px;"></span>
        Active Exchanges
    </h2>
    <div class="table-wrapper">
        <div class="table-header">
            <span>Total: {{ client_exchanges|length }} active exchange{{ client_exchanges|length|pluralize }}</span>
        </div>
        <table>
            <thead>
            <tr>
                <th>Name</th>
                <th>My Share %</th>
                <th>Company Share %</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for ce in client_exchanges %}
                <tr>
                    <td>
                        <a href="{% url 'clients:balance' client.pk %}?exchange={{ ce.pk }}" style="color: var(--accent); text-decoration: none; font-weight: 600;">{{ ce.exchange.name }}{% if ce.exchange.code %} ({{ ce.exchange.code }}){% endif %}</a>
                    </td>
                    <td>{{ ce.my_share_pct }}%</td>
                    <td>{{ ce.company_share_pct }}%</td>
                    <td>
                        <a href="{% url 'exchanges:edit_client_link' ce.pk %}" class="btn btn-sm">Edit</a>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="4" style="text-align: center; padding: 40px; color: var(--muted);">No active exchanges configured yet.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Inactive Exchanges Section -->
<div class="mt-4">
    <h2 style="font-size: 22px; font-weight: 600; margin-bottom: 16px; color: var(--text); display: flex; align-items: center; gap: 8px;">
        <span style="width: 4px; height: 24px; background: var(--muted); border-radius: 2px;"></span>
        Inactive Exchanges
    </h2>
    <div class="table-wrapper">
        <div class="table-header">
            <span>Total: {{ inactive_client_exchanges|length }} inactive exchange{{ inactive_client_exchanges|length|pluralize }}</span>
        </div>
        <table>
            <thead>
            <tr>
                <th>Name</th>
                <th>My Share %</th>
                <th>Company Share %</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for ce in inactive_client_exchanges %}
                <tr>
                    <td>
                        <a href="{% url 'clients:balance' client.pk %}?exchange={{ ce.pk }}" style="color: var(--accent); text-decoration: none; font-weight: 600;">{{ ce.exchange.name }}{% if ce.exchange.code %} ({{ ce.exchange.code }}){% endif %}</a>
                    </td>
                    <td>{{ ce.my_share_pct }}%</td>
                    <td>{{ ce.company_share_pct }}%</td>
                    <td>
                        <a href="{% url 'exchanges:edit_client_link' ce.pk %}" class="btn btn-sm">Edit</a>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="4" style="text-align: center; padding: 40px; color: var(--muted);">No inactive exchanges.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="mt-3">
    <div class="table-wrapper">
        <div class="table-header">
            <span>Recent Transactions</span>
        </div>
        <table>
            <thead>
            <tr>
                <th>Date</th>
                <th>Exchange</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Your Share</th>
                <th>Client Share</th>
            </tr>
            </thead>
            <tbody>
            {% for tx in transactions %}
                <tr>
                    <td>{{ tx.date }}</td>
                    <td>{{ tx.client_exchange.exchange.name }}</td>
                    <td>{{ tx.get_transaction_type_display }}</td>
                    <td>₹ {{ tx.amount }}</td>
                    <td>₹ {{ tx.your_share_amount }}</td>
                    <td>₹ {{ tx.client_share_amount }}</td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="6">No transactions yet.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Give Money Modal/Form -->
<div id="give-money-form" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--bg-content); border-radius: 8px; padding: 24px; border: 1px solid var(--border); max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="font-size: 20px; font-weight: 600; margin: 0;">Give Money to {{ client.name }}</h2>
            <button onclick="hideGiveMoneyForm()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted);">&times;</button>
        </div>
        <form method="post" action="{% url 'clients:give_money' client.pk %}">
            {% csrf_token %}
            <div class="form-row">
                <label class="field-label">Select Exchange *</label>
                <select name="client_exchange" class="field-input" required>
                    <option value="">-- Select an exchange --</option>
                    {% for ce in client_exchanges %}
                        <option value="{{ ce.pk }}">{{ ce.exchange.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-row">
                <label class="field-label">Date *</label>
                <input type="date" name="date" class="field-input" value="{% now 'Y-m-d' %}" required>
            </div>
            
            <div class="form-row">
                <label class="field-label">Amount (₹) *</label>
                <input type="number" name="amount" class="field-input" step="0.01" min="0" required placeholder="0.00">
            </div>
            
            <div class="form-row">
                <label class="field-label">Note (Optional)</label>
                <textarea name="note" class="field-input" rows="3" placeholder="Add any notes about this transaction"></textarea>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button type="submit" class="btn btn-primary">Give Money</button>
                <button type="button" onclick="hideGiveMoneyForm()" class="btn">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    function showGiveMoneyForm() {
        document.getElementById('give-money-form').style.display = 'flex';
    }
    
    function hideGiveMoneyForm() {
        document.getElementById('give-money-form').style.display = 'none';
    }
    
    // Close modal when clicking outside
    document.getElementById('give-money-form').addEventListener('click', function(e) {
        if (e.target === this) {
            hideGiveMoneyForm();
        }
    });
</script>
{% endblock %}


